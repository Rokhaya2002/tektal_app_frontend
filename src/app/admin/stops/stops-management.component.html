<div class="stops-management-container">
  <header class="page-header">
    <div class="header-content">
      <div class="header-left">
        <button class="back-btn" (click)="navigateToDashboard()">
          <span>â†</span> Retour
        </button>
        <h1>Gestion des ArrÃªts</h1>
      </div>
      <div class="header-actions">
        <button class="add-stop-btn" (click)="openAddStopModal()">
          <span>â•</span> Ajouter un ArrÃªt
        </button>
        <button class="nav-btn" routerLink="/admin/lines">
          <span>ğŸšŒ</span> GÃ©rer les Lignes
        </button>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="content-grid">
      <!-- Formulaire -->
      <div class="form-section">
        <div class="form-card">
          <h2>{{ isEditing ? "Modifier l'ArrÃªt" : "Nouvel ArrÃªt" }}</h2>

          <form [formGroup]="stopForm" (ngSubmit)="onSubmit()">
            <div class="form-group">
              <label for="name">Nom de l'arrÃªt</label>
              <input
                type="text"
                id="name"
                formControlName="name"
                placeholder="Ex: Gare Centrale"
                [class.error]="
                  stopForm.get('name')?.invalid && stopForm.get('name')?.touched
                "
              />
              <div
                class="error-message"
                *ngIf="
                  stopForm.get('name')?.invalid && stopForm.get('name')?.touched
                "
              >
                <span *ngIf="stopForm.get('name')?.errors?.['required']"
                  >Nom requis</span
                >
              </div>
            </div>

            <div class="error-message" *ngIf="errorMessage">
              {{ errorMessage }}
            </div>

            <div class="success-message" *ngIf="successMessage">
              {{ successMessage }}
            </div>

            <div class="form-actions">
              <button
                type="submit"
                [disabled]="stopForm.invalid || loading"
                class="submit-btn"
              >
                <span *ngIf="loading">Enregistrement...</span>
                <span *ngIf="!loading">{{
                  isEditing ? "Modifier" : "CrÃ©er"
                }}</span>
              </button>
              <button
                type="button"
                *ngIf="isEditing"
                (click)="cancelEdit()"
                class="cancel-btn"
              >
                Annuler
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Liste des arrÃªts -->
      <div class="list-section">
        <div class="list-card">
          <h2>ArrÃªts existants</h2>

          <div class="loading-indicator" *ngIf="loading">
            <p>Chargement des arrÃªts...</p>
          </div>

          <div class="stops-table-wrapper" *ngIf="!loading">
            <table class="stops-table">
              <thead>
                <tr>
                  <th>Nom de l'arrÃªt</th>
                  <th style="width: 90px; text-align: right">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let stop of paginatedStops">
                  <td class="stop-table-name">{{ stop.name }}</td>
                  <td class="stop-table-actions">
                    <button
                      class="edit-btn"
                      (click)="editStop(stop)"
                      title="Modifier"
                    >
                      âœï¸
                    </button>
                    <button
                      class="delete-btn"
                      (click)="deleteStop(stop.id)"
                      title="Supprimer"
                    >
                      ğŸ—‘ï¸
                    </button>
                  </td>
                </tr>
                <tr *ngIf="paginatedStops.length === 0">
                  <td colspan="2" class="empty-state">
                    Aucun arrÃªt crÃ©Ã© pour le moment
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="stops-table-pagination" *ngIf="stops.length > pageSize">
              <button
                (click)="prevPage()"
                [disabled]="page === 1"
                class="pagination-btn"
              >
                â† PrÃ©cÃ©dent
              </button>
              <div class="page-info">
                <span
                  >Page {{ page }} sur
                  {{ Math.ceil(stops.length / pageSize) }}</span
                >
                <span class="total-info"
                  >({{ stops.length }} arrÃªts au total)</span
                >
              </div>
              <button
                (click)="nextPage()"
                [disabled]="!hasMoreStops()"
                class="pagination-btn"
              >
                Suivant â†’
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal pour ajouter/sÃ©lectionner un arrÃªt -->
  <div
    class="modal-overlay"
    *ngIf="showAddStopModal"
    (click)="closeAddStopModal()"
  >
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Ajouter un ArrÃªt</h2>
        <button class="close-btn" (click)="closeAddStopModal()">
          <span>âœ•</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Guide d'utilisation mobile -->
        <div class="mobile-guide" *ngIf="isMobileDevice()">
          <div class="guide-content">
            <h3>ğŸ“± Guide d'utilisation mobile</h3>
            <ul>
              <li>
                <strong>Tapez</strong> le nom de l'arrÃªt dans la barre de
                recherche
              </li>
              <li>
                <strong>Cliquez</strong> sur un arrÃªt existant pour le
                sÃ©lectionner
              </li>
              <li>
                <strong>Ou crÃ©ez</strong> un nouvel arrÃªt si l'arrÃªt n'existe
                pas
              </li>
            </ul>
          </div>
        </div>

        <!-- Recherche d'arrÃªts existants -->
        <div class="search-section">
          <label for="searchInput">Rechercher un arrÃªt existant :</label>
          <input
            type="text"
            id="searchInput"
            [(ngModel)]="searchTerm"
            (input)="searchStops()"
            placeholder="Tapez le nom de l'arrÃªt..."
            class="search-input"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
          />
        </div>

        <!-- RÃ©sultats de recherche -->
        <div class="search-results" *ngIf="searchTerm.trim() !== ''">
          <!-- ArrÃªts existants trouvÃ©s -->
          <div class="existing-stops" *ngIf="filteredStops.length > 0">
            <h3>ArrÃªts existants :</h3>
            <div
              class="stop-option"
              *ngFor="let stop of filteredStops"
              (click)="selectExistingStop(stop)"
            >
              <div class="stop-option-info">
                <span class="stop-name">{{ stop.name }}</span>
              </div>
              <span class="select-indicator">Cliquez pour sÃ©lectionner</span>
            </div>
          </div>

          <!-- Option pour crÃ©er un nouvel arrÃªt -->
          <div class="create-new-option" *ngIf="isCreatingNew">
            <h3>CrÃ©er un nouvel arrÃªt :</h3>
            <div class="new-stop-preview">
              <p><strong>Nom :</strong> {{ searchTerm }}</p>
              <p class="info-text">Cliquez ci-dessous pour crÃ©er cet arrÃªt</p>
            </div>
            <button class="create-new-btn" (click)="createNewStop()">
              <span>â•</span> CrÃ©er "{{ searchTerm }}"
            </button>
          </div>

          <!-- Aucun rÃ©sultat -->
          <div
            class="no-results"
            *ngIf="filteredStops.length === 0 && !isCreatingNew"
          >
            <p>Aucun arrÃªt trouvÃ© avec ce nom</p>
          </div>
        </div>

        <!-- Formulaire pour nouvel arrÃªt -->
        <div
          class="new-stop-form"
          *ngIf="isCreatingNew && selectedStop === null"
        >
          <h3>CrÃ©er un nouvel arrÃªt</h3>
          <form [formGroup]="stopForm" (ngSubmit)="confirmAddStop()">
            <div class="form-group">
              <label for="modalName">Nom de l'arrÃªt</label>
              <input
                type="text"
                id="modalName"
                formControlName="name"
                placeholder="Ex: Gare Centrale"
                [class.error]="
                  stopForm.get('name')?.invalid && stopForm.get('name')?.touched
                "
              />
            </div>

            <div class="modal-actions">
              <button
                type="submit"
                [disabled]="stopForm.invalid || loading"
                class="confirm-btn"
              >
                <span *ngIf="loading">CrÃ©ation...</span>
                <span *ngIf="!loading">CrÃ©er l'arrÃªt</span>
              </button>
              <button
                type="button"
                (click)="closeAddStopModal()"
                class="cancel-btn"
              >
                Annuler
              </button>
            </div>
          </form>
        </div>

        <!-- Confirmation pour arrÃªt existant -->
        <div class="existing-stop-confirmation" *ngIf="selectedStop">
          <h3>ArrÃªt sÃ©lectionnÃ© :</h3>
          <div class="selected-stop-info">
            <p><strong>Nom :</strong> {{ selectedStop.name }}</p>
          </div>
          <div class="modal-actions">
            <button class="confirm-btn" (click)="confirmAddStop()">
              Utiliser cet arrÃªt
            </button>
            <button
              type="button"
              (click)="closeAddStopModal()"
              class="cancel-btn"
            >
              Annuler
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
